<div class="w-full max-w-7xl mx-auto h-screen p-2 sm:p-4 flex flex-col items-center text-center">
    
    <header class="w-full mb-4">
        <h1 class="text-4xl sm:text-5xl font-bold text-cyan-400 tracking-wider" style="text-shadow: 0 0 10px #0891b2;">
            Maze Quest
        </h1>
    </header>

    @if (gameStatus() !== 'start') {
    <div class="w-full max-w-xl bg-slate-800/50 rounded-lg p-2 sm:p-4 mb-4 flex flex-wrap justify-center items-center gap-y-2 gap-x-6 text-lg sm:text-xl">
        <div>Level: <span class="font-bold text-yellow-400">{{ level() }}</span></div>
        <div>Time: <span class="font-bold text-yellow-400">{{ timer() }}s</span></div>
        <div>Score: <span class="font-bold text-yellow-400">{{ score() }}</span></div>
        <div class="flex items-center gap-2">
            <button (click)="skipLevels()" title="Skip 1 Level" class="px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded text-sm font-bold transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed" [disabled]="level() === 29">
                +1 Level
            </button>
            <button (click)="toggleMinimap()" title="Toggle Minimap" class="px-3 py-1 bg-cyan-700 hover:bg-cyan-600 rounded text-sm font-bold transition-colors">
                @if (showMinimap()) {
                    Hide Map
                } @else {
                    View Map
                }
            </button>
            <button (click)="toggleMute()" class="p-2 rounded-full hover:bg-slate-700 transition-colors">
                @if(isMuted()) {
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2 2m2-2l2 2" /></svg>
                } @else {
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                }
            </button>
        </div>
    </div>
    }

    <main class="flex-grow w-full relative overflow-hidden grid place-items-center">
        @if (gameStatus() === 'playing' || gameStatus() === 'level-complete' || gameStatus() === 'game-over') {
        <div #mazeContainer class="relative overflow-auto p-2 bg-black/30 rounded-lg shadow-2xl shadow-cyan-500/20 max-h-full max-w-full">
            <div class="grid" [style.grid-template-columns]="'repeat(' + mazeWidth + ', auto)'">
                @for (row of maze(); let y = $index; track $index) {
                    @for (cell of row; let x = $index; track (y + '-' + $index)) {
                    <div [id]="'cell-' + y + '-' + x" class="w-4 h-4 sm:w-6 sm:h-6 lg:w-8 lg:h-8 relative" [class]="getCellClass(cell, x, y)">
                        @if (x === playerPosition().x && y === playerPosition().y && !playerHit()) {
                            <div class="absolute inset-0.5 sm:inset-1 flex items-center justify-center">
                                @if (level() > 30) {
                                    <div class="w-full h-full animate-spin-slow" style="background: conic-gradient(from 90deg at 50% 50%, #ff00ff, #00ffff, #ffff00, #ff00ff); clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></div>
                                } @else {
                                    <div class="w-full h-full bg-yellow-400 rounded-full animate-pulse shadow-lg shadow-yellow-400/50">
                                    </div>
                                }
                            </div>
                        }
                        @for (enemy of enemies(); track $index) {
                            @if (x === enemy.x && y === enemy.y) {
                            <div class="absolute inset-0.5 sm:inset-1 flex items-center justify-center">
                                <div class="w-full h-full bg-red-600 rounded-full shadow-lg shadow-red-500/50"></div>
                            </div>
                            }
                        }
                        @for (stalker of stalkers(); track $index) {
                            @if (x === stalker.x && y === stalker.y) {
                                <div class="absolute inset-1 sm:inset-2 flex items-center justify-center">
                                    <div class="w-full h-full bg-white shadow-lg shadow-white/50 animate-pulse" style="clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></div>
                                </div>
                            }
                        }
                        @for (regenPos of regenerateIconPositions(); track $index) {
                            @if (x === regenPos.x && y === regenPos.y) {
                                <div class="absolute inset-1 sm:inset-2 flex items-center justify-center">
                                    <div class="w-full h-full bg-cyan-400 rounded-sm animate-spin shadow-lg shadow-cyan-400/50"></div>
                                </div>
                            }
                        }
                        @for (teleporter of teleporterPositions(); track $index) {
                            @if (x === teleporter.x && y === teleporter.y) {
                                <div class="absolute inset-1 sm:inset-2 flex items-center justify-center">
                                    <div class="w-full h-full bg-fuchsia-500 rounded-sm animate-spin shadow-lg shadow-fuchsia-500/50"></div>
                                </div>
                            }
                        }
                    </div>
                    }
                }
            </div>
        </div>
        }

        @if (gameStatus() === 'playing' && showMinimap()) {
            <div class="absolute top-4 right-4 bg-slate-900/50 backdrop-blur-sm p-2 rounded-lg border border-cyan-500/50 shadow-lg z-20">
                <div class="grid" [style.grid-template-columns]="'repeat(' + mazeWidth + ', auto)'">
                    @for (row of maze(); let y = $index; track $index) {
                        @for (cell of row; let x = $index; track $index) {
                            <div class="w-1 h-1" [class]="getMinimapCellClass(cell, x, y)"></div>
                        }
                    }
                </div>
            </div>
        }

        @if (gameStatus() === 'start') {
        <div class="bg-slate-800/80 backdrop-blur-sm p-6 sm:p-8 rounded-lg text-center shadow-lg w-full max-w-md md:max-w-4xl">
            <h2 class="text-3xl mb-6">Welcome to Maze Quest!</h2>
            <button (click)="startGame()" class="px-8 py-4 bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-bold rounded-lg text-2xl transition-transform transform hover:scale-105">
                Start Game
            </button>
            <div class="mt-8 pt-6 border-t border-slate-600/50 text-left flex flex-col md:flex-row gap-6 md:gap-8">
                <!-- Legend Section -->
                <div class="flex-1">
                    <h3 class="text-xl text-cyan-400 mb-4 text-center font-bold">Legend</h3>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div class="flex items-center gap-3"><div class="w-5 h-5 bg-yellow-400 rounded-full flex-shrink-0"></div><span>You</span></div>
                        <div class="flex items-center gap-3"><div class="w-5 h-5 bg-green-600 flex-shrink-0"></div><span>Exit</span></div>
                        <div class="flex items-center gap-3"><div class="w-5 h-5 bg-red-600 rounded-full flex-shrink-0"></div><span>Enemy</span></div>
                        <div class="flex items-center gap-3"><div class="w-5 h-5 bg-white flex-shrink-0" style="clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></div><span>Stalker</span></div>
                        <div class="flex items-center gap-3"><div class="w-5 h-5 bg-cyan-400 rounded-sm animate-spin flex-shrink-0"></div><span>Regenerate Maze</span></div>
                        <div class="flex items-center gap-3"><div class="w-5 h-5 bg-fuchsia-500 rounded-sm animate-spin flex-shrink-0"></div><span>Teleporter</span></div>
                    </div>
                </div>
                <!-- Instructions Section -->
                <div class="flex-1 border-t md:border-t-0 md:border-l border-slate-600/50 pt-6 md:pt-0 md:pl-8">
                     <h3 class="text-xl text-cyan-400 mb-4 text-center font-bold">How to Play</h3>
                     <ul class="space-y-3 text-sm text-slate-300">
                        <li class="flex items-start gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-400 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                            <span>Use <kbd class="font-sans bg-slate-700 px-2 py-0.5 rounded-md border-b-2 border-slate-600">Arrow Keys</kbd> or <kbd class="font-sans bg-slate-700 px-2 py-0.5 rounded-md border-b-2 border-slate-600">WASD</kbd> to move.</span>
                        </li>
                        <li class="flex items-start gap-3">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            <span>Reach the <strong class="text-green-400">green tile</strong> to advance to the next level.</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            <span>The white <strong class="text-white">Stalker</strong> is deadly! If it catches you, it's <strong class="text-red-500">Game Over</strong>.</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        }

        @if (gameStatus() === 'level-complete') {
        <div class="absolute inset-0 bg-black/70 flex items-center justify-center z-10">
            <div class="text-center animate-fade-in-up">
                <h2 class="text-5xl font-bold text-green-400">Level {{ level() }} Complete!</h2>
                <p class="text-2xl mt-4 text-yellow-300">Score: {{ score() }}</p>
                <p class="text-xl mt-4">Get ready for the next challenge...</p>
            </div>
        </div>
        }

        @if (gameStatus() === 'game-over') {
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-10 p-4">
            <div class="text-center animate-fade-in-up bg-slate-800/50 p-8 rounded-2xl shadow-2xl shadow-red-500/20 max-w-lg">
                <h2 class="text-4xl sm:text-5xl font-bold text-red-500">GAME OVER</h2>
                <p class="text-lg sm:text-xl mt-6 text-slate-200">
                    The Stalker got you! Better luck next time.
                </p>
                <p class="text-xl mt-6 text-yellow-300">You reached Level: {{ level() }}</p>
                <p class="text-2xl mt-2 text-yellow-300">Final Score: {{ score() }}</p>
                <div class="mt-8 flex justify-center">
                    <button (click)="restartGame()" class="px-8 py-4 bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-bold rounded-lg text-xl transition-transform transform hover:scale-105">
                        Play Again
                    </button>
                </div>
            </div>
        </div>
        }

        @if (gameStatus() === 'game-complete') {
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-10 p-4">
            <div class="text-center animate-fade-in-up bg-slate-800/50 p-8 rounded-2xl shadow-2xl shadow-cyan-400/20 max-w-lg">
                <h2 class="text-4xl sm:text-5xl font-bold text-yellow-400">MAZE MASTER!</h2>
                <p class="text-lg sm:text-xl mt-6 text-slate-200">
                    You've conquered the maze! Are you secretly a Minotaur with a GPS? Incredible work!
                </p>
                <p class="text-2xl mt-6 text-yellow-300">Final Score: {{ score() }}</p>
                <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
                    <button (click)="restartGame()" class="px-6 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg text-lg transition-transform transform hover:scale-105">
                        Back to Start
                    </button>
                    <button (click)="continueToInfinite()" class="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg text-lg transition-transform transform hover:scale-105">
                        Continue to Infinite Maze
                    </button>
                </div>
                <div class="mt-6 pt-6 border-t border-slate-600">
                    <p class="text-slate-400 mb-3">Share your victory!</p>
                    <div class="flex justify-center gap-4">
                        <button (click)="shareOnFacebook()" title="Share on Facebook" class="p-3 bg-blue-600 hover:bg-blue-500 rounded-full transition-transform transform hover:scale-110">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"></path></svg>
                        </button>
                        <button (click)="shareOnWhatsApp()" title="Share on WhatsApp" class="p-3 bg-green-500 hover:bg-green-400 rounded-full transition-transform transform hover:scale-110">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.38 1.25 4.81L2 22l5.3-1.38c1.37.71 2.93 1.12 4.55 1.12h.1c5.46 0 9.91-4.45 9.91-9.91s-4.45-9.91-9.91-9.91zM17.43 15.8c-.24-.13-.56-1.02-1.39-1.39-.12-.04-.24-.07-.35-.07-.22 0-.44.05-.64.12-.4.13-1.05.9-1.26 1.11-.21.21-.42.24-.78.1-.73-.28-2.23-1.2-3.7-2.95-.27-.3-.54-.6-.78-.95-.24-.35-.04-.56.12-.73.13-.13.28-.33.42-.49.18-.18.24-.3.3-.51.06-.21 0-.38-.07-.51-.07-.13-1.05-2.28-1.42-3.09-.36-.8-.73-.68-.99-.68-.22 0-.47 0-.7.02-.24.02-.62.09-.94.46s-1.05.9-1.05 2.18c0 1.28.64 2.53 1.05 3.11.04.04 1.7 2.58 4.21 4.21.6.39 1.28.71 1.88.92.73.27 1.34.21 1.83.12.56-.1.88-.41 1.21-.78.33-.38.33-.71.22-.84z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        }
    </main>
    
    @if (gameStatus() === 'playing') {
    <footer class="mt-4 lg:hidden"> <!-- Only show on small/medium screens -->
        <div class="grid grid-cols-3 gap-2 w-48">
            <div></div>
            <button (click)="movePlayer(0, -1)" class="bg-slate-700 aspect-square rounded-lg flex items-center justify-center active:bg-cyan-500 transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
            </button>
            <div></div>
            <button (click)="movePlayer(-1, 0)" class="bg-slate-700 aspect-square rounded-lg flex items-center justify-center active:bg-cyan-500 transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <div></div>
            <button (click)="movePlayer(1, 0)" class="bg-slate-700 aspect-square rounded-lg flex items-center justify-center active:bg-cyan-500 transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
            <div></div>
            <button (click)="movePlayer(0, 1)" class="bg-slate-700 aspect-square rounded-lg flex items-center justify-center active:bg-cyan-500 transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </button>
            <div></div>
        </div>
    </footer>
    }
    <audio #levelCompleteSound src="src/assets/level-complete.mp3" preload="auto"></audio>
    <audio #backgroundMusic src="src/assets/background-music.mp3" loop preload="auto"></audio>
    <audio #infiniteMusic src="src/assets/infinite-music.mp3" loop preload="auto"></audio>
    <audio #gameCompleteMusic src="src/assets/game-complete.mp3" preload="auto"></audio>
</div>